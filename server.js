// server.js
require('dotenv').config();
const express = require('express');
const axios = require('axios');
const { v4: uuidv4 } = require('uuid');

const app = express();

// ====== PARSERS ======
app.use(express.json());
app.use(express.urlencoded({ extended: true })); // InSales —à–ª—ë—Ç form-urlencoded

// ====== ENV ======
const SHOP_ID = process.env.SHOP_ID;                  // –ÆKassa: 1003537
const SECRET_KEY = process.env.SECRET_KEY;            // –ÆKassa: test_* –∏–ª–∏ live_*
const INS_DOMAIN = process.env.INS_DOMAIN;            // myshop-xxxx.myinsales.ru
const INS_API_KEY = process.env.INS_API_KEY;          // API key InSales
const INS_API_PASSWORD = process.env.INS_API_PASSWORD;// API password InSales
const PORT = process.env.PORT || 3000;

if (!SHOP_ID || !SECRET_KEY || !INS_DOMAIN || !INS_API_KEY || !INS_API_PASSWORD) {
  console.warn('‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å .env ‚Äî –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.');
}

const ykAuthHeader = 'Basic ' + Buffer.from(`${SHOP_ID}:${SECRET_KEY}`).toString('base64');

// ====== InSales –∫–ª–∏–µ–Ω—Ç ======
const insales = axios.create({
  baseURL: `https://${INS_DOMAIN}`,
  auth: { username: INS_API_KEY, password: INS_API_PASSWORD },
  timeout: 15000,
});

// ====== helpers ======
const money = (v) => Number(v || 0).toFixed(2);

// –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑ –∏–∑ InSales –ø–æ ID
async function fetchOrder(orderId) {
  const { data } = await insales.get(`/admin/orders/${orderId}.json`);
  return data.order ? data.order : data;
}

// –ü–æ–ª—É—á–∞–µ–º sku/barcode –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
async function fetchVariantInfo(productId, variantId) {
  const { data } = await insales.get(`/admin/products/${productId}.json`);
  const product = data.product ? data.product : data;
  const v = (product.variants || []).find(x => String(x.id) === String(variantId));
  return { barcode: v?.barcode || null, sku: v?.sku || null };
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –∑–∞–∫–∞–∑–∞ ‚Üí YooKassa articles[]
 * TRU –±–µ—Ä—ë–º –∏–∑ SKU (–∞—Ä—Ç–∏–∫—É–ª). –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî variant.sku, –∑–∞—Ç–µ–º barcode.
 */
async function buildArticlesFromOrder(order) {
  const lines = order.line_items || order.order_lines || [];
  const out = [];
  let idx = 1;

  for (const li of lines) {
    let tru = li.sku || li?.variant?.sku || null;

    if (!tru && li.product_id && li.variant_id) {
      try {
        const vi = await fetchVariantInfo(li.product_id, li.variant_id);
        tru = vi.sku || vi.barcode || null;
      } catch (_) {}
    }
    if (!tru) tru = li.barcode || li?.variant?.barcode || null;

    if (!tru) continue; // —Å—Ç—Ä–æ–∫—É –±–µ–∑ TRU –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

    const quantity = Number(li.quantity || 1);
    const unitPrice = money(li.sale_price ?? li.price ?? 0);

    out.push({
      article_number: idx++,
      tru_code: String(tru), // –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π TRU/GTIN
      article_code: String(li.variant_id ?? li.product_id ?? li.sku ?? ''),
      article_name: String(li.title || '–¢–æ–≤–∞—Ä'),
      quantity,
      price: { value: unitPrice, currency: 'RUB' },
    });
  }

  return out;
}

function amountFromArticles(articles) {
  const sum = articles.reduce((acc, a) => acc + Number(a.price.value) * Number(a.quantity), 0);
  return money(sum);
}

// ====== ROUTES ======

// Health-check –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–µ–∫—Ä–µ—Ç—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º)
app.get('/env-check', (req, res) => {
  res.json({
    SHOP_ID: !!process.env.SHOP_ID,
    SECRET_KEY: !!process.env.SECRET_KEY,
    INS_DOMAIN: process.env.INS_DOMAIN || null,
    INS_API_KEY: !!process.env.INS_API_KEY,
    INS_API_PASSWORD: !!process.env.INS_API_PASSWORD,
    PORT: process.env.PORT || 3000
  });
});

// –¢–ï–°–¢: –ø–æ–∫–∞–∑–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞ (sku/barcode)
app.get('/test-order/:id', async (req, res) => {
  try {
    const order = await fetchOrder(req.params.id);
    res.json({
      order_id: order.id,
      number: order.number,
      lines: (order.line_items || order.order_lines || []).map(li => ({
        title: li.title,
        quantity: li.quantity,
        price: li.sale_price ?? li.price,
        sku_in_line: li.sku || null,
        variant_sku: li?.variant?.sku || null,
        barcode_in_line: li.barcode || null,
        variant_barcode: li?.variant?.barcode || null,
        product_id: li.product_id || null,
        variant_id: li.variant_id || null
      }))
    });
  } catch (e) {
    console.error('test-order error:', e?.response?.data || e.message);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—å ID –∏ –¥–æ—Å—Ç—É–ø—ã API.' });
  }
});

// –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
app.get('/', (req, res) => {
  res.send('üöÄ YooKassa ES: POST /insales/start | GET /pay-by-es?order_id=...&return_url=... | GET /test-order/:id | GET /env-check');
});

/**
 * ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /insales/start:
 * - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç POST –æ—Ç InSales (order_json)
 * - –£–º–µ–µ—Ç —Ä—É—á–Ω–æ–π GET-—Ç–µ—Å—Ç: /insales/start?order_id=123&return_url=...
 * - –õ–æ–≥–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —à–∞–≥–∏
 * - –®–ª—ë—Ç –≤ –ÆKassa articles –Ω–∞ –í–ï–†–•–ù–ï–ú –£–†–û–í–ù–ï
 * - –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ÆKassa (—É–¥–æ–±–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
 */
app.all('/insales/start', async (req, res) => {
  try {
    const method = req.method;
    console.log('[/insales/start] method=', method, 'ct=', req.headers['content-type']);

    // 1) –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑
    let orderObj = null;

    if (method === 'POST' && (req.body?.order_json)) {
      console.log('[/insales/start] body keys:', Object.keys(req.body));
      orderObj = typeof req.body.order_json === 'string'
        ? JSON.parse(req.body.order_json)
        : req.body.order_json;
    } else if (method === 'GET' && req.query.order_id) {
      console.log('[/insales/start] GET order_id=', req.query.order_id);
      orderObj = await fetchOrder(req.query.order_id);
    }

    if (!orderObj?.id) {
      console.error('[/insales/start] no order_json or no id');
      return res.status(400).send('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞: –Ω—É–∂–µ–Ω POST —Å order_json (InSales) –∏–ª–∏ GET c ?order_id=');
    }

    // 2) –°–æ–±–∏—Ä–∞–µ–º articles
    const articles = await buildArticlesFromOrder(orderObj);
    console.log('[/insales/start] articles count=', articles.length);
    if (!articles.length) {
      return res.status(400).send('–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π —Å TRU (–ø—Ä–æ–≤–µ—Ä—å SKU/—à—Ç—Ä–∏—Ö–∫–æ–¥—ã —É –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)');
    }

    // 3) –°—É–º–º–∞
    const amount = amountFromArticles(articles);
    console.log('[/insales/start] amount=', amount);

    // 4) –ü–ª–∞—Ç—ë–∂ –≤ –ÆKassa (articles ‚Äî top-level!)
    const idempotenceKey = uuidv4();
    const { data: pay } = await axios.post(
      'https://api.yookassa.ru/v3/payments',
      {
        amount: { value: amount, currency: 'RUB' },
        payment_method_data: { type: 'electronic_certificate' },
        articles,
        confirmation: {
          type: 'redirect',
          return_url: req.query.return_url || `https://${INS_DOMAIN}/account/orders`
        },
        capture: true,
        description: `–ó–∞–∫–∞–∑ ‚Ññ${orderObj.number || orderObj.id} (–≠–°)`,
        metadata: { order_id: String(orderObj.id) }
      },
      {
        headers: {
          'Content-Type': 'application/json',
          'Idempotence-Key': idempotenceKey,
          Authorization: ykAuthHeader,
        },
        timeout: 20000,
      }
    );

    const confirmationUrl = pay?.confirmation?.confirmation_url;
    if (!confirmationUrl) {
      console.error('[/insales/start] No confirmation_url. YooKassa resp:', pay);
      return res.status(502).send('–ÆKassa –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ confirmation_url');
    }

    console.log('[/insales/start] redirect to', confirmationUrl);
    return res.redirect(302, confirmationUrl);
  } catch (e) {
    const err = e?.response?.data || e.message;
    console.error('[/insales/start] ERROR:', err);
    return res
      .status(500)
      .send('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ InSales: ' + (typeof err === 'string' ? err : JSON.stringify(err)));
  }
});

// –†—É—á–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
app.get('/pay-by-es', async (req, res) => {
  const { order_id, return_url } = req.query;
  if (!order_id || !return_url) {
    return res.status(400).send('–ù—É–∂–Ω—ã query: order_id –∏ return_url');
  }

  try {
    const order = await fetchOrder(order_id);
    const articles = await buildArticlesFromOrder(order);
    if (!articles.length) {
      return res.status(400).send('–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π —Å TRU (–ø—Ä–æ–≤–µ—Ä—å SKU/—à—Ç—Ä–∏—Ö–∫–æ–¥—ã —É –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)');
    }

    const amount = amountFromArticles(articles);

    const idempotenceKey = uuidv4();
    const { data: pay } = await axios.post(
      'https://api.yookassa.ru/v3/payments',
      {
        amount: { value: amount, currency: 'RUB' },
        payment_method_data: { type: 'electronic_certificate' },
        articles,
        confirmation: { type: 'redirect', return_url },
        capture: true,
        description: `–ó–∞–∫–∞–∑ ‚Ññ${order.number || order.id}`,
        metadata: { order_id: String(order.id) }
      },
      {
        headers: {
          'Content-Type': 'application/json',
          'Idempotence-Key': idempotenceKey,
          Authorization: ykAuthHeader,
        },
        timeout: 20000,
      }
    );

    const confirmationUrl = pay?.confirmation?.confirmation_url;
    if (!confirmationUrl) {
      return res.status(502).send('–ÆKassa –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ confirmation_url');
    }

    return res.redirect(302, confirmationUrl);
  } catch (e) {
    console.error('pay-by-es error:', e?.response?.data || e.message);
    return res.status(500).send('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
  }
});

// ====== START ======
app.listen(PORT, '0.0.0.0', () => {
  console.log(`‚úÖ Server listening on ${PORT}`);
});
